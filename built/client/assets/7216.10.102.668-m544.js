/*! For license information please see 7216.10.102.668-m544.js.LICENSE.txt */
(self.webpackChunkmisskey=self.webpackChunkmisskey||[]).push([[7216],{42569:function(e,t){var a,s,o;s=[e,t],a=function(e,t){"use strict";var a,s,o="function"==typeof Map?new Map:(a=[],s=[],{has:function(e){return a.indexOf(e)>-1},get:function(e){return s[a.indexOf(e)]},set:function(e,t){-1===a.indexOf(e)&&(a.push(e),s.push(t))},delete:function(e){var t=a.indexOf(e);t>-1&&(a.splice(t,1),s.splice(t,1))}}),n=function(e){return new Event(e,{bubbles:!0})};try{new Event("test")}catch(e){n=function(e){var t=document.createEvent("Event");return t.initEvent(e,!0,!1),t}}function i(e){if(e&&e.nodeName&&"TEXTAREA"===e.nodeName&&!o.has(e)){var t=null,a=null,s=null,i=function(){e.clientWidth!==a&&g()},r=function(t){window.removeEventListener("resize",i,!1),e.removeEventListener("input",g,!1),e.removeEventListener("keyup",g,!1),e.removeEventListener("autosize:destroy",r,!1),e.removeEventListener("autosize:update",g,!1),Object.keys(t).forEach((function(a){e.style[a]=t[a]})),o.delete(e)}.bind(e,{height:e.style.height,resize:e.style.resize,overflowY:e.style.overflowY,overflowX:e.style.overflowX,wordWrap:e.style.wordWrap});e.addEventListener("autosize:destroy",r,!1),"onpropertychange"in e&&"oninput"in e&&e.addEventListener("keyup",g,!1),window.addEventListener("resize",i,!1),e.addEventListener("input",g,!1),e.addEventListener("autosize:update",g,!1),e.style.overflowX="hidden",e.style.wordWrap="break-word",o.set(e,{destroy:r,update:g}),d()}function d(){var a=window.getComputedStyle(e,null);"vertical"===a.resize?e.style.resize="none":"both"===a.resize&&(e.style.resize="horizontal"),t="content-box"===a.boxSizing?-(parseFloat(a.paddingTop)+parseFloat(a.paddingBottom)):parseFloat(a.borderTopWidth)+parseFloat(a.borderBottomWidth),isNaN(t)&&(t=0),g()}function l(t){var a=e.style.width;e.style.width="0px",e.offsetWidth,e.style.width=a,e.style.overflowY=t}function c(e){for(var t=[];e&&e.parentNode&&e.parentNode instanceof Element;)e.parentNode.scrollTop&&t.push({node:e.parentNode,scrollTop:e.parentNode.scrollTop}),e=e.parentNode;return t}function m(){if(0!==e.scrollHeight){var s=c(e),o=document.documentElement&&document.documentElement.scrollTop;e.style.height="",e.style.height=e.scrollHeight+t+"px",a=e.clientWidth,s.forEach((function(e){e.node.scrollTop=e.scrollTop})),o&&(document.documentElement.scrollTop=o)}}function g(){m();var t=Math.round(parseFloat(e.style.height)),a=window.getComputedStyle(e,null),o="content-box"===a.boxSizing?Math.round(parseFloat(a.height)):e.offsetHeight;if(o<t?"hidden"===a.overflowY&&(l("scroll"),m(),o="content-box"===a.boxSizing?Math.round(parseFloat(window.getComputedStyle(e,null).height)):e.offsetHeight):"hidden"!==a.overflowY&&(l("hidden"),m(),o="content-box"===a.boxSizing?Math.round(parseFloat(window.getComputedStyle(e,null).height)):e.offsetHeight),s!==o){s=o;var i=n("autosize:resized");try{e.dispatchEvent(i)}catch(e){}}}}function r(e){var t=o.get(e);t&&t.destroy()}function d(e){var t=o.get(e);t&&t.update()}var l=null;"undefined"==typeof window||"function"!=typeof window.getComputedStyle?((l=function(e){return e}).destroy=function(e){return e},l.update=function(e){return e}):((l=function(e,t){return e&&Array.prototype.forEach.call(e.length?e:[e],(function(e){return i(e,t)})),e}).destroy=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],r),e},l.update=function(e){return e&&Array.prototype.forEach.call(e.length?e:[e],d),e}),t.default=l,e.exports=t.default},void 0===(o="function"==typeof a?a.apply(t,s):a)||(e.exports=o)},26071:(e,t,a)=>{var s=a(11063),o=a(26143)(s);o.push([e.id,'.mk-messaging-form>textarea[data-v-6ad319e6]{background:transparent;border:none;border-radius:0;border-top:1px solid var(--faceDivider);box-shadow:none;color:var(--inputText);cursor:auto;display:block;font-size:1em;height:64px;margin:0;max-width:100%;min-width:100%;outline:none;padding:8px;resize:none;width:100%}.mk-messaging-form>.file[data-v-6ad319e6]{background:#eee;color:#444;cursor:pointer;padding:8px}.mk-messaging-form>.send[data-v-6ad319e6]{bottom:0;color:#aaa;font-size:1em;margin:0;padding:10px 14px;position:absolute;right:0;transition:color .1s ease}.mk-messaging-form>.send[data-v-6ad319e6]:hover{color:var(--primary)}.mk-messaging-form>.send[data-v-6ad319e6]:active{color:var(--primaryDarken10);transition:color 0s ease}.mk-messaging-form .files[data-v-6ad319e6]{display:block;list-style:none;margin:0;padding:0 8px}.mk-messaging-form .files[data-v-6ad319e6]:after{clear:both;content:"";display:block}.mk-messaging-form .files>li[data-v-6ad319e6]{background-color:#eee;background-position:50%;background-repeat:no-repeat;background-size:cover;cursor:move;display:block;float:left;height:64px;margin:4px;padding:0;width:64px}.mk-messaging-form .files>li:hover>.remove[data-v-6ad319e6]{display:block}.mk-messaging-form .files>li>.remove[data-v-6ad319e6]{background:transparent;border:none;border-radius:0;box-shadow:none;cursor:pointer;display:none;margin:0;outline:none;padding:0;position:absolute;right:-6px;top:-6px}.mk-messaging-form .attach-from-drive[data-v-6ad319e6],.mk-messaging-form .attach-from-local[data-v-6ad319e6],.mk-messaging-form .emoji[data-v-6ad319e6]{color:#aaa;font-size:1em;font-weight:400;margin:0;padding:10px 14px;text-decoration:none;transition:color .1s ease}.mk-messaging-form .attach-from-drive[data-v-6ad319e6]:hover,.mk-messaging-form .attach-from-local[data-v-6ad319e6]:hover,.mk-messaging-form .emoji[data-v-6ad319e6]:hover{color:var(--primary)}.mk-messaging-form .attach-from-drive[data-v-6ad319e6]:active,.mk-messaging-form .attach-from-local[data-v-6ad319e6]:active,.mk-messaging-form .emoji[data-v-6ad319e6]:active{color:var(--primaryDarken10);transition:color 0s ease}.mk-messaging-form input[type=file][data-v-6ad319e6]{display:none}',""]),e.exports=o},72879:(e,t,a)=>{var s=a(11063),o=a(26143)(s);o.push([e.id,'.message[data-v-608c71e4]{background-color:transparent;padding:10px 12px}.message>.avatar[data-v-608c71e4]{border-radius:8px;display:block;height:54px;position:absolute;top:10px;transition:all .1s ease;width:54px}.message>.content>.balloon[data-v-608c71e4]{align-items:center;border-radius:16px;display:flex;max-width:calc(100% - 16px);min-height:38px;padding:0}.message>.content>.balloon[data-v-608c71e4]:before{content:"";display:block;pointer-events:none;position:absolute;top:12px}.message>.content>.balloon+*[data-v-608c71e4]{clear:both}.message>.content>.balloon:hover>.delete-button[data-v-608c71e4]{display:block}.message>.content>.balloon>.delete-button[data-v-608c71e4]{background:transparent;border:none;border-radius:0;box-shadow:none;cursor:pointer;display:none;margin:0;outline:none;padding:0;position:absolute;right:-4px;top:-4px;z-index:1}.message>.content>.balloon>.delete-button>img[data-v-608c71e4]{cursor:pointer;height:16px;vertical-align:bottom;width:16px}.message>.content>.balloon>.content[data-v-608c71e4]{max-width:100%}.message>.content>.balloon>.content>.is-deleted[data-v-608c71e4]{color:rgba(0,0,0,.5);display:block;font-size:1em;margin:0;overflow:hidden;overflow-wrap:break-word;padding:0}.message>.content>.balloon>.content>.text[data-v-608c71e4]{color:rgba(0,0,0,.8);display:block;font-size:1em;margin:0;overflow:hidden;overflow-wrap:break-word;padding:8px 16px;word-break:break-word}.message>.content>.balloon>.content>.text+.file>a[data-v-608c71e4]{border-radius:0 0 16px 16px}.message>.content>.balloon>.content>.file>a[data-v-608c71e4]{border-radius:16px;display:block;max-width:100%;overflow:hidden;text-decoration:none}.message>.content>.balloon>.content>.file>a[data-v-608c71e4]:hover{text-decoration:none}.message>.content>.balloon>.content>.file>a:hover>p[data-v-608c71e4]{background:#ccc}.message>.content>.balloon>.content>.file>a>*[data-v-608c71e4]{display:block;margin:0;max-height:512px;object-fit:contain;width:100%}.message>.content>.balloon>.content>.file>a>p[data-v-608c71e4]{background:#ddd;color:#555;padding:30px;text-align:center}.message>.content>.mk-url-preview[data-v-608c71e4]{margin:8px 0}.message>.content>footer[data-v-608c71e4]{color:var(--messagingRoomMessageInfo);display:block;font-size:10px;margin:2px 0 0}.message>.content>footer>.read[data-v-608c71e4]{margin:0 8px}.message>.content>footer>[data-icon][data-v-608c71e4]{margin-left:4px}.message:not([data-is-me])>.avatar[data-v-608c71e4]{left:12px}.message:not([data-is-me])>.content[data-v-608c71e4]{padding-left:66px}.message:not([data-is-me])>.content>.balloon[data-v-608c71e4]{background:var(--messagingRoomMessageBg);float:left}.message:not([data-is-me])>.content>.balloon[data-no-text][data-v-608c71e4]{background:transparent}.message:not([data-is-me])>.content>.balloon[data-v-608c71e4]:not([data-no-text]):before{border:8px solid transparent;border-right:8px solid var(--messagingRoomMessageBg);left:-14px}.message:not([data-is-me])>.content>.balloon>.content>.text[data-v-608c71e4]{color:var(--messagingRoomMessageFg)}.message:not([data-is-me])>.content>footer[data-v-608c71e4]{text-align:left}.message[data-is-me]>.avatar[data-v-608c71e4]{right:12px}.message[data-is-me]>.content[data-v-608c71e4]{padding-right:66px}.message[data-is-me]>.content>.balloon[data-v-608c71e4]{background:var(--primary);float:right}.message[data-is-me]>.content>.balloon[data-no-text][data-v-608c71e4]{background:transparent}.message[data-is-me]>.content>.balloon[data-v-608c71e4]:not([data-no-text]):before{border:8px solid transparent;border-left:8px solid var(--primary);left:auto;right:-14px}.message[data-is-me]>.content>.balloon>.content>p.is-deleted[data-v-608c71e4]{color:hsla(0,0%,100%,.5)}.message[data-is-me]>.content>.balloon>.content>.text[data-v-608c71e4] ,.message[data-is-me]>.content>.balloon>.content>.text[data-v-608c71e4] *{color:#fff!important}.message[data-is-me]>.content>footer[data-v-608c71e4]{text-align:right}.message[data-is-me]>.content>footer>.read[data-v-608c71e4]{user-select:none}.message[data-is-deleted]>.balloon[data-v-608c71e4]{opacity:.5}',""]),e.exports=o},91387:(e,t,a)=>{var s=a(11063),o=a(26143)(s);o.push([e.id,'.mk-messaging-room[data-v-6264b1cd]{background:var(--face)}.mk-messaging-room>.body[data-v-6264b1cd]{margin:0 auto;max-width:600px;min-height:calc(100% - 103px);width:100%}.mk-messaging-room>.body>.empty[data-v-6264b1cd],.mk-messaging-room>.body>.init[data-v-6264b1cd]{color:var(--messagingRoomInfo);font-size:.8em;margin:0;opacity:.5;padding:16px 8px 8px;text-align:center;width:100%}.mk-messaging-room>.body>.empty [data-icon][data-v-6264b1cd],.mk-messaging-room>.body>.init [data-icon][data-v-6264b1cd]{margin-right:4px}.mk-messaging-room>.body>.no-history[data-v-6264b1cd]{color:var(--messagingRoomInfo);display:block;font-size:.8em;margin:0;opacity:.5;padding:16px;text-align:center}.mk-messaging-room>.body>.no-history [data-icon][data-v-6264b1cd]{margin-right:4px}.mk-messaging-room>.body>.more[data-v-6264b1cd]{background:rgba(0,0,0,.3);border-radius:12px;color:#fff;display:block;line-height:24px;margin:16px auto;padding:0 12px}.mk-messaging-room>.body>.more[data-v-6264b1cd]:hover{background:rgba(0,0,0,.4)}.mk-messaging-room>.body>.more[data-v-6264b1cd]:active{background:rgba(0,0,0,.5)}.mk-messaging-room>.body>.more.fetching[data-v-6264b1cd]{cursor:wait}.mk-messaging-room>.body>.more>[data-icon][data-v-6264b1cd]{margin-right:4px}.mk-messaging-room>.body>.date[data-v-6264b1cd]{display:block;margin:8px 0;text-align:center}.mk-messaging-room>.body>.date[data-v-6264b1cd]:before{background:var(--messagingRoomDateDividerLine);content:"";display:block;height:1px;left:0;margin:0 auto;position:absolute;right:0;top:16px;width:90%}.mk-messaging-room>.body>.date>span[data-v-6264b1cd]{color:var(--messagingRoomDateDividerText);display:inline-block;line-height:32px;margin:0;padding:0 16px}.mk-messaging-room>footer[data-v-6264b1cd]{background:var(--face);background-clip:content-box;bottom:0;margin:0 auto;max-width:600px;padding:0;position:-webkit-sticky;position:sticky;width:100%;z-index:2}.mk-messaging-room>footer>.new-message[data-v-6264b1cd]{padding:8px 0;position:absolute;text-align:center;top:-48px;width:100%}.mk-messaging-room>footer>.new-message>button[data-v-6264b1cd]{background:var(--primary);border-radius:16px;color:var(--primaryForeground);cursor:pointer;display:inline-block;font-size:12px;line-height:32px;margin:0;padding:0 12px 0 30px}.mk-messaging-room>footer>.new-message>button[data-v-6264b1cd]:hover{background:var(--primaryLighten10)}.mk-messaging-room>footer>.new-message>button[data-v-6264b1cd]:active{background:var(--primaryDarken10)}.mk-messaging-room>footer>.new-message>button>i[data-v-6264b1cd]{font-size:16px;left:10px;line-height:32px;position:absolute;top:0}.fade-enter-active[data-v-6264b1cd],.fade-leave-active[data-v-6264b1cd]{transition:opacity .1s}.fade-enter[data-v-6264b1cd],.fade-leave-to[data-v-6264b1cd]{opacity:0;transition:opacity .5s}',""]),e.exports=o},17216:(e,t,a)=>{"use strict";a.r(t),a.d(t,{default:()=>v});var s=a(31508),o=a(46813),n=a(58945),i=a(49733);const r=s.ZP.extend({i18n:(0,o.Z)("common/views/components/messaging-room.message.vue"),props:{message:{required:!0}},computed:{isMe(){return this.message.userId==this.$store.state.i.id},urls(){if(this.message.text){const e=(0,n.np)(this.message.text);return(0,i.Tw)(e.filter((e=>("url"==e.type||"link"==e.type)&&e.props.url&&!e.props.silent)).map((e=>e.props.url)))}return null}},methods:{del(){this.$root.api("messaging/messages/delete",{messageId:this.message.id})}}});a(8182);var d=a(26385);const l=(0,d.Z)(r,(function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"message",attrs:{"data-is-me":e.isMe}},[t("mk-avatar",{staticClass:"avatar",attrs:{user:e.message.user,target:"_blank"}}),t("div",{staticClass:"content"},[t("div",{staticClass:"balloon",attrs:{"data-no-text":null==e.message.text}},[e.isMe?t("button",{staticClass:"delete-button",attrs:{title:e.$t("@.delete")},on:{click:e.del}},[t("img",{attrs:{src:"/assets/desktop/remove.png",alt:"Delete"}})]):e._e(),e.message.isDeleted?t("div",{staticClass:"content"},[t("p",{staticClass:"is-deleted"},[e._v(e._s(e.$t("deleted")))])]):t("div",{staticClass:"content"},[e.message.text?t("mfm",{ref:"text",staticClass:"text",attrs:{text:e.message.text,i:e.$store.state.i,direction:e.isMe?"left":"right"}}):e._e(),e.message.file?t("div",{staticClass:"file"},[t("a",{attrs:{href:e.message.file.url,rel:"noopener",target:"_blank",title:e.message.file.name}},["image"==e.message.file.type.split("/")[0]?t("img",{style:{backgroundColor:"var(--face)"},attrs:{src:e.message.file.url,alt:e.message.file.name}}):t("p",[e._v(e._s(e.message.file.name))])])]):e._e()],1)]),t("div"),e._l(e.urls,(function(e){return t("mk-url-preview",{key:e,attrs:{url:e}})})),t("footer",[e.isMe&&e.message.isRead?t("span",{staticClass:"read"},[e._v(e._s(e.$t("is-read")))]):e._e(),t("mk-time",{attrs:{time:e.message.createdAt}}),e.message.is_edited?[t("fa",{attrs:{icon:"pencil-alt"}})]:e._e()],2)],2)],1)}),[],!1,null,"608c71e4",null).exports;var c=a(42569),m=a(31178);const g=s.ZP.extend({i18n:(0,o.Z)("common/views/components/messaging-room.form.vue"),props:["user"],data:()=>({text:null,file:null,sending:!1}),computed:{draftId(){return this.user.id},canSend(){return null!=this.text&&""!=this.text||null!=this.file},room(){return this.$parent}},watch:{text(){this.saveDraft()},file(){this.saveDraft(),this.room.isBottom()&&this.room.scrollToBottom()}},mounted(){c(this.$refs.textarea);const e=JSON.parse(localStorage.getItem("message_drafts")||"{}")[this.draftId];e&&(this.text=e.data.text,this.file=e.data.file)},methods:{onPaste(e){const t=e.clipboardData.items;if(1==t.length){if("file"==t[0].kind){const e=t[0].getAsFile(),a=e.name.lastIndexOf("."),s=a>=0?e.name.slice(a):"",o=`${(new Date).toISOString().replace(/\D/g,"").substr(0,14)}${s}`;this.upload(e,o)}}else"file"==t[0].kind&&alert(this.$t("only-one-file-attached"))},onDragover(e){const t="file"==e.dataTransfer.items[0].kind,a="mk_drive_file"==e.dataTransfer.types[0];(t||a)&&(e.preventDefault(),e.dataTransfer.dropEffect="all"==e.dataTransfer.effectAllowed?"copy":"move")},onDrop(e){if(1==e.dataTransfer.files.length)return e.preventDefault(),void this.upload(e.dataTransfer.files[0]);if(e.dataTransfer.files.length>1)return e.preventDefault(),void alert(this.$t("only-one-file-attached"));const t=e.dataTransfer.getData("mk_drive_file");null!=t&&""!=t&&(this.file=JSON.parse(t),e.preventDefault())},onKeypress(e){(10==e.which||13==e.which)&&e.ctrlKey&&this.canSend&&this.send()},chooseFile(){this.$refs.file.click()},chooseFileFromDrive(){this.$chooseDriveFile({multiple:!1}).then((e=>{this.file=e}))},onChangeFile(){this.upload(this.$refs.file.files[0])},upload(e,t){this.$refs.uploader.upload(e,null,t,!1,!0)},onUploaded(e){this.file=e},send(){this.sending=!0,this.$root.api("messaging/messages/create",{userId:this.user.id,text:this.text?this.text:void 0,fileId:this.file?this.file.id:void 0}).then((e=>{this.clear()})).catch((e=>{console.error(e)})).then((()=>{this.sending=!1}))},clear(){this.text="",this.file=null,this.deleteDraft()},saveDraft(){const e=JSON.parse(localStorage.getItem("message_drafts")||"{}");e[this.draftId]={updatedAt:new Date,data:{text:this.text,file:this.file}},localStorage.setItem("message_drafts",JSON.stringify(e))},deleteDraft(){const e=JSON.parse(localStorage.getItem("message_drafts")||"{}");delete e[this.draftId],localStorage.setItem("message_drafts",JSON.stringify(e))},async emoji(){const e=await a.e(2529).then(a.bind(a,62529)).then((e=>e.default)),t=this.$refs.emoji,s=t.getBoundingClientRect(),o=this.$root.new(e,{x:t.offsetWidth+s.left+window.pageXOffset,y:s.top+window.pageYOffset});o.$once("chosen",(e=>{(0,m.Z)(this.$refs.textarea,e+(e.startsWith(":")?String.fromCharCode(8203):""))})),this.$once("hook:beforeDestroy",(()=>{o.close()}))}}});a(57357);const p=(0,d.Z)(g,(function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"mk-messaging-form",on:{dragover:function(t){return t.stopPropagation(),e.onDragover.apply(null,arguments)},drop:function(t){return t.stopPropagation(),e.onDrop.apply(null,arguments)}}},[t("textarea",{directives:[{name:"model",rawName:"v-model",value:e.text,expression:"text"},{name:"autocomplete",rawName:"v-autocomplete",value:{model:"text"},expression:"{ model: 'text' }"}],ref:"textarea",attrs:{placeholder:e.$t("input-message-here")},domProps:{value:e.text},on:{keypress:e.onKeypress,paste:e.onPaste,input:function(t){t.target.composing||(e.text=t.target.value)}}}),e.file?t("div",{staticClass:"file",on:{click:function(t){e.file=null}}},[e._v(e._s(e.file.name))]):e._e(),t("mk-uploader",{ref:"uploader",on:{uploaded:e.onUploaded}}),t("button",{staticClass:"send",attrs:{disabled:!e.canSend||e.sending,title:e.$t("send")},on:{click:e.send}},[e.sending?e._e():[t("fa",{attrs:{icon:"paper-plane"}})],e.sending?[t("fa",{attrs:{icon:"spinner .spin"}})]:e._e()],2),t("button",{staticClass:"attach-from-local",attrs:{title:e.$t("attach-from-local")},on:{click:e.chooseFile}},[t("fa",{attrs:{icon:"upload"}})],1),t("button",{staticClass:"attach-from-drive",attrs:{title:e.$t("attach-from-drive")},on:{click:e.chooseFileFromDrive}},[t("fa",{attrs:{icon:["far","folder-open"]}})],1),t("input",{ref:"file",attrs:{type:"file"},on:{change:e.onChangeFile}}),t("button",{ref:"emoji",staticClass:"emoji",on:{click:e.emoji}},[t("fa",{attrs:{icon:["far","laugh"]}})],1)],1)}),[],!1,null,"6ad319e6",null).exports;var f=a(87114),h=a(32971);const u=s.ZP.extend({i18n:(0,o.Z)("common/views/components/messaging-room.vue"),components:{XMessage:l,XForm:p},props:["user","isNaked"],data:()=>({init:!0,fetchingMoreMessages:!1,messages:[],existMoreMessages:!1,connection:null,showIndicator:!1,timer:null,faArrowCircleDown:h.DY}),computed:{_messages(){return this.messages.map((e=>{const t=new Date(e.createdAt).getDate(),a=new Date(e.createdAt).getMonth()+1;return e._date=t,e._datetext=this.$t("@.month-and-day").replace("{month}",a.toString()).replace("{day}",t.toString()),e}))},form(){return this.$refs.form}},mounted(){this.connection=this.$root.stream.connectToChannel("messaging",{otherparty:this.user.id}),this.connection.on("message",this.onMessage),this.connection.on("read",this.onRead),this.connection.on("deleted",this.onDeleted),this.isNaked?window.addEventListener("scroll",this.onScroll,{passive:!0}):this.$el.addEventListener("scroll",this.onScroll,{passive:!0}),document.addEventListener("visibilitychange",this.onVisibilitychange),this.fetchMessages().then((()=>{this.init=!1,this.scrollToBottom()}))},beforeDestroy(){this.connection.dispose(),this.isNaked?window.removeEventListener("scroll",this.onScroll):this.$el.removeEventListener("scroll",this.onScroll),document.removeEventListener("visibilitychange",this.onVisibilitychange)},methods:{onDragover(e){const t="file"==e.dataTransfer.items[0].kind,a="mk_drive_file"==e.dataTransfer.types[0];e.dataTransfer.dropEffect=t||a?"all"==e.dataTransfer.effectAllowed?"copy":"move":"none"},onDrop(e){if(1==e.dataTransfer.files.length)return void this.form.upload(e.dataTransfer.files[0]);if(e.dataTransfer.files.length>1)return void alert(this.$t("only-one-file-attached"));const t=e.dataTransfer.getData("mk_drive_file");if(null!=t&&""!=t){const e=JSON.parse(t);this.form.file=e}},fetchMessages(){return new Promise(((e,t)=>{const a=this.existMoreMessages?20:10;this.$root.api("messaging/messages",{userId:this.user.id,limit:a+1,untilId:this.existMoreMessages?this.messages[0].id:void 0}).then((t=>{t.length==a+1?(this.existMoreMessages=!0,t.pop()):this.existMoreMessages=!1,this.messages.unshift.apply(this.messages,t.reverse()),e()}))}))},fetchMoreMessages(){this.fetchingMoreMessages=!0,this.fetchMessages().then((()=>{this.fetchingMoreMessages=!1}))},onMessage(e){if(this.$store.state.device.enableSounds){const e=new Audio(`${f.HQ}/assets/message.mp3`);e.volume=this.$store.state.device.soundVolume,e.play()}const t=this.isBottom();this.messages.push(e),e.userId==this.$store.state.i.id||document.hidden||this.connection.send("read",{id:e.id}),t?this.$nextTick((()=>{this.scrollToBottom()})):e.userId!=this.$store.state.i.id&&this.notifyNewMessage()},onRead(e){Array.isArray(e)||(e=[e]);for(const t of e)if(this.messages.some((e=>e.id==t))){const e=this.messages.map((e=>e.id)).indexOf(t);this.messages[e].isRead=!0}},onDeleted(e){const t=this.messages.find((t=>t.id===e));t&&(this.messages=this.messages.filter((e=>e.id!==t.id)))},isBottom(){return(this.isNaked?window.scrollY+window.innerHeight:this.$el.scrollTop+this.$el.offsetHeight)>(this.isNaked?document.body.offsetHeight:this.$el.scrollHeight)-64},scrollToBottom(){this.isNaked?window.scroll(0,document.body.offsetHeight):this.$el.scrollTop=this.$el.scrollHeight},onIndicatorClick(){this.showIndicator=!1,this.scrollToBottom()},notifyNewMessage(){this.showIndicator=!0,this.timer&&clearTimeout(this.timer),this.timer=setTimeout((()=>{this.showIndicator=!1}),4e3)},onScroll(){const e=this.isNaked?window.document.documentElement:this.$el;e.scrollTop+e.clientHeight>e.scrollHeight-1&&(this.showIndicator=!1)},onVisibilitychange(){if(!document.hidden)for(const e of this.messages)e.userId===this.$store.state.i.id||e.isRead||this.connection.send("read",{id:e.id})}}});a(3788);const v=(0,d.Z)(u,(function(){var e=this,t=e._self._c;e._self._setupProxy;return t("div",{staticClass:"mk-messaging-room",on:{dragover:function(t){return t.preventDefault(),t.stopPropagation(),e.onDragover.apply(null,arguments)},drop:function(t){return t.preventDefault(),t.stopPropagation(),e.onDrop.apply(null,arguments)}}},[t("div",{staticClass:"body"},[e.init?t("p",{staticClass:"init"},[t("fa",{attrs:{icon:"spinner .spin"}}),e._v(e._s(e.$t("@.loading")))],1):e._e(),e.init||0!=e.messages.length?e._e():t("p",{staticClass:"empty"},[t("fa",{attrs:{icon:"info-circle"}}),e._v(e._s(e.$t("empty")))],1),!e.init&&e.messages.length>0&&!e.existMoreMessages?t("p",{staticClass:"no-history"},[t("fa",{attrs:{icon:"flag"}}),e._v(e._s(e.$t("no-history")))],1):e._e(),e.existMoreMessages?t("button",{staticClass:"more",class:{fetching:e.fetchingMoreMessages},attrs:{disabled:e.fetchingMoreMessages},on:{click:e.fetchMoreMessages}},[e.fetchingMoreMessages?[t("fa",{attrs:{icon:"spinner",pulse:"","fixed-width":""}})]:e._e(),e._v(e._s(e.fetchingMoreMessages?e.$t("@.loading"):e.$t("@.load-more"))+"\n\t\t")],2):e._e(),e._l(e._messages,(function(a,s){return[t("x-message",{key:a.id,attrs:{message:a}}),s!=e.messages.length-1&&a._date!=e._messages[s+1]._date?t("p",{staticClass:"date"},[t("span",[e._v(e._s(e._messages[s+1]._datetext))])]):e._e()]}))],2),t("footer",[t("transition",{attrs:{name:"fade"}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.showIndicator,expression:"showIndicator"}],staticClass:"new-message"},[t("button",{on:{click:e.onIndicatorClick}},[t("i",[t("fa",{attrs:{icon:e.faArrowCircleDown}})],1),e._v(e._s(e.$t("new-message")))])])]),t("x-form",{ref:"form",attrs:{user:e.user}})],1)])}),[],!1,null,"6264b1cd",null).exports},57357:(e,t,a)=>{var s=a(26071);s.__esModule&&(s=s.default),"string"==typeof s&&(s=[[e.id,s,""]]),s.locals&&(e.exports=s.locals);(0,a(80950).Z)("54d7c694",s,!0,{})},8182:(e,t,a)=>{var s=a(72879);s.__esModule&&(s=s.default),"string"==typeof s&&(s=[[e.id,s,""]]),s.locals&&(e.exports=s.locals);(0,a(80950).Z)("938f4a12",s,!0,{})},3788:(e,t,a)=>{var s=a(91387);s.__esModule&&(s=s.default),"string"==typeof s&&(s=[[e.id,s,""]]),s.locals&&(e.exports=s.locals);(0,a(80950).Z)("6840a309",s,!0,{})}}]);