{"version":3,"sources":["models/note.js"],"names":["isValidCw","hideNote","packMany","pack","Note","db","get","createIndex","sparse","unique","createdAt","score","_id","replyId","dropIndex","catch","text","length","trim","packedNote","meId","hide","visibility","equals","userId","specified","visibleUserIds","some","id","reply","mentions","following","Following","findOne","followeeId","transform","followerId","fileIds","files","appId","reactionCounts","renoteCount","repliesCount","poll","cw","tags","isHidden","notes","me","options","items","Promise","all","map","n","removeError","filter","x","src","packed","opts","Object","assign","detail","skipHide","isObjectId","mongo","ObjectID","deepcopy","dbLogger","warn","decodeReactionCounts","populateEmojis","_user","host","rs","keys","startsWith","decodeReaction","replace","packEmojis","emojis","concat","e","console","populatePoll","multiple","votes","PollVote","find","noteId","myChoices","choices","y","choice","myChoice","isVoted","vote","populateMyReaction","reaction","NoteReaction","deletedAt","$exists","populateMyRenote","renote","renoteId","nodes","parseFull","extractEmojis","awaitAll","toOidString","toISODateOrNull","updatedAt","expiresAt","user","packUser","__user","viaMobile","localOnly","copyOnce","quoteCount","reactions","packFileMany","uri","sanitizeUrl","url","toOidStringOrNull","app","packApp","hasRemoteMentions","mentionedRemoteUsers","referenceIds","reverse","references","myReaction","myRenoteId","mfmTypes","extractMfmTypes","decorationMfmTypes","includes","notHaveDecorationMfm","isCat","nyaize","c"],"mappings":";;;;;;;;IA8CA,OAAoB;eAApB;;IAEgBA,SAAS;eAATA;;IAmHHC,QAAQ;eAARA;;IAuEAC,QAAQ;eAARA;;IAqBAC,IAAI;eAAJA;;;yBA/PU;0BACG;0BACX;4BACQ;yBACA;sBACiB;0BACnB;8BACI;2BAC4B;2BAC/B;4BACK;wBACF;6BAC4B;uBAC3B;0BAED;qBACO;2BACgC;wBACtC;iCACM;wBACT;+BACO;6BACF;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAE5B,MAAMC,OAAOC,iBAAE,CAACC,GAAG,CAAQ;AAC3BF,KAAKG,WAAW,CAAC,OAAO;IAAEC,QAAQ;IAAMC,QAAQ;AAAK;AACrDL,KAAKG,WAAW,CAAC;AACjBH,KAAKG,WAAW,CAAC;AACjBH,KAAKG,WAAW,CAAC;AACjBH,KAAKG,WAAW,CAAC;AACjBH,KAAKG,WAAW,CAAC;AACjBH,KAAKG,WAAW,CAAC;AACjBH,KAAKG,WAAW,CAAC;AACjBH,KAAKG,WAAW,CAAC;IAAEG,WAAW,CAAC;AAAE;AACjCN,KAAKG,WAAW,CAAC;IAAEI,OAAO,CAAC;AAAE,GAAG;IAAEH,QAAQ;AAAK;AAE/CJ,KAAKG,WAAW,CAAC;IAAE,cAAc;IAAGK,KAAK,CAAC;AAAE;AAC5CR,KAAKG,WAAW,CAAC;IAAE,cAAc;IAAGM,SAAS;IAAGD,KAAK,CAAC;AAAE;AACxDR,KAAKU,SAAS,CAAC,cAAcC,KAAK,CAAC,KAAO;AAE1CX,KAAKG,WAAW,CAAC;AACjBH,KAAKG,WAAW,CAAC;AAEjBH,KAAKG,WAAW,CAAC;IAAE,UAAU;IAAGK,KAAK,CAAC;AAAE;AACxCR,KAAKU,SAAS,CAAC,UAAUC,KAAK,CAAC,KAAO;MAEtC,WAAeX;AAER,SAASJ,UAAUgB,IAAY;IACrC,OAAOC,IAAAA,eAAM,EAACD,KAAKE,IAAI,OAAO;AAC/B;AAiHO,MAAMjB,WAAW,OAAOkB,YAAwBC;IACtD,IAAIC,OAAO;IAEX,0DAA0D;IAC1D,IAAIF,WAAWG,UAAU,IAAI,aAAcF,CAAAA,QAAQ,QAAQ,CAACA,KAAKG,MAAM,CAACJ,WAAWK,MAAM,CAAA,GAAI;QAC5FH,OAAO;IACR;IAEA,6CAA6C;IAC7C,IAAIF,WAAWG,UAAU,IAAI,aAAa;QACzC,IAAIF,QAAQ,MAAM;YACjBC,OAAO;QACR,OAAO,IAAID,KAAKG,MAAM,CAACJ,WAAWK,MAAM,GAAG;YAC1CH,OAAO;QACR,OAAO;YACN,cAAc;YACd,MAAMI,YAAYN,WAAWO,cAAc,CAACC,IAAI,CAAC,CAACC,KAAYR,KAAKG,MAAM,CAACK;YAE1E,IAAIH,WAAW;gBACdJ,OAAO;YACR,OAAO;gBACNA,OAAO;YACR;QACD;IACD;IAEA,iDAAiD;IACjD,IAAIF,WAAWG,UAAU,IAAI,aAAa;QACzC,IAAIF,QAAQ,MAAM;YACjBC,OAAO;QACR,OAAO,IAAID,KAAKG,MAAM,CAACJ,WAAWK,MAAM,GAAG;YAC1CH,OAAO;QACR,OAAO,IAAIF,WAAWU,KAAK,IAAIT,KAAKG,MAAM,CAACJ,WAAWU,KAAK,CAACL,MAAM,GAAG;YACpE,gBAAgB;YAChBH,OAAO;QACR,OAAO,IAAIF,WAAWW,QAAQ,IAAIX,WAAWW,QAAQ,CAACH,IAAI,CAAC,CAACC,KAAYR,KAAKG,MAAM,CAACK,MAAM;YACzF,YAAY;YACZP,OAAO;QACR,OAAO;YACN,YAAY;YACZ,MAAMU,YAAY,MAAMC,kBAAS,CAACC,OAAO,CAAC;gBACzCC,YAAYC,IAAAA,iBAAS,EAAChB,WAAWK,MAAM;gBACvCY,YAAYhB;YACb;YAEA,IAAIW,aAAa,MAAM;gBACtBV,OAAO;YACR,OAAO;gBACNA,OAAO;YACR;QACD;IACD;IAEA,IAAIA,MAAM;QACTF,WAAWkB,OAAO,GAAG,EAAE;QACvBlB,WAAWmB,KAAK,GAAG,EAAE;QACrBnB,WAAWN,OAAO,GAAG;QACrBM,WAAWU,KAAK,GAAG;QACnBV,WAAWoB,KAAK,GAAG;QACnBpB,WAAWO,cAAc,GAAG,EAAE;QAC9BP,WAAWqB,cAAc,GAAG,CAAC;QAC7BrB,WAAWsB,WAAW,GAAG;QACzBtB,WAAWuB,YAAY,GAAG;QAC1BvB,WAAWH,IAAI,GAAG;QAClBG,WAAWwB,IAAI,GAAG;QAClBxB,WAAWyB,EAAE,GAAG;QAChBzB,WAAW0B,IAAI,GAAG,EAAE;QACpB1B,WAAW2B,QAAQ,GAAG;IACvB;AACD;AAEO,MAAM5C,WAAW,OACvB6C,OACAC,IACAC;IAMA,MAAMC,QAAQ,MAAMC,QAAQC,GAAG,CAACL,MAAMM,GAAG,CAACC,CAAAA,IAAKnD,KAAKmD,GAAGN,IAAIC;IAC3D,OAAO,AAACA,WAAWA,QAAQM,WAAW,GAAIL,MAAMM,MAAM,CAACC,CAAAA,IAAKA,KAAK,QAAQP;AAC1E;AAUO,MAAM/C,OAAO,OACnBuD,KACAV,IACAC;QAkKiB5C,oBACNA,cACSA,0BAUJA,iCAsBZsD;IA/LJ,MAAMC,OAAOC,OAAOC,MAAM,CAAC;QAC1BC,QAAQ;QACRC,UAAU;IACX,GAAGf;IAEH,KAAK;IACL,MAAM7B,OAA8B4B,KACjCiB,IAAAA,mBAAU,EAACjB,MACVA,KACA,OAAOA,OAAO,WACb,IAAIkB,SAAMC,QAAQ,CAACnB,MACnB,AAACA,GAAapC,GAAG,GACnB;IAEH,IAAIP;IAEJ,oCAAoC;IACpC,IAAI4D,IAAAA,mBAAU,EAACP,MAAM;QACpBrD,KAAK,MAAMD,KAAK6B,OAAO,CAAC;YACvBrB,KAAK8C;QACN;IACD,OAAO,IAAI,OAAOA,QAAQ,UAAU;QACnCrD,KAAK,MAAMD,KAAK6B,OAAO,CAAC;YACvBrB,KAAK,IAAIsD,SAAMC,QAAQ,CAACT;QACzB;IACD,OAAO;QACNrD,KAAK+D,UAASV;IACf;IAEA,sCAAsC;IACtC,IAAIrD,MAAM,MAAM;QACfgE,gBAAQ,CAACC,IAAI,CAAC,CAAC,oCAAoC,EAAEZ,IAAI,CAAC;QAC1D,OAAO;IACR;IAEA,MAAMlB,iBAAiBnC,GAAGmC,cAAc,GAAG+B,IAAAA,iCAAoB,EAAClE,GAAGmC,cAAc,IAAI,CAAC;IAEtF,MAAMgC,iBAAiB;QACtB,iDAAiD;QACjD,IAAInE,GAAIoE,KAAK,EAAE;YACd,MAAMC,OAAOrE,GAAIoE,KAAK,CAACC,IAAI;YAC3B,MAAMC,KAAKd,OAAOe,IAAI,CAACpC,gBACrBgB,MAAM,CAACC,CAAAA,IAAKA,KAAKA,EAAEoB,UAAU,CAAC,MAC9BxB,GAAG,CAACI,CAAAA,IAAKqB,IAAAA,2BAAc,EAACrB,IACxBJ,GAAG,CAACI,CAAAA,IAAKA,EAAEsB,OAAO,CAAC,MAAM;YAE3B,OAAOC,IAAAA,sBAAU,EAAC3E,GAAI4E,MAAM,CAACC,MAAM,CAACP,KAAKD,MACvC3D,KAAK,CAACoE,CAAAA;gBACNC,QAAQd,IAAI,CAACa;gBACb,OAAO,EAAE;YACV;QACF,OAAO;YACN,OAAO,EAAE;QACV;IACD;IAEA,MAAME,eAAe;QACpB,MAAM1C,OAAOtC,GAAIsC,IAAI;QACrB,IAAIA,KAAK2C,QAAQ,EAAE;YAClB,MAAMC,QAAQ,MAAMC,iBAAQ,CAACC,IAAI,CAAC;gBACjCjE,QAAQJ;gBACRsE,QAAQrF,GAAIO,GAAG;YAChB;YAEA,MAAM+E,YAAY,AAAChD,KAAKiD,OAAO,CAAepC,MAAM,CAACC,CAAAA,IAAK8B,MAAM5D,IAAI,CAACkE,CAAAA,IAAKpC,EAAE7B,EAAE,IAAIiE,EAAEC,MAAM;YAC1F,KAAK,MAAMC,YAAYJ,UAAW;gBAChCI,SAAiBC,OAAO,GAAG;YAC7B;YAEA,OAAOrD;QACR,OAAO;YACNA,KAAK2C,QAAQ,GAAG;QACjB;QAEA,MAAMW,OAAO,MAAMT,iBAAQ,CACzBvD,OAAO,CAAC;YACRT,QAAQJ;YACRsE,QAAQrF,GAAIO,GAAG;QAChB;QAED,IAAIqF,MAAM;YACT,MAAMF,WAAW,AAACpD,KAAKiD,OAAO,CAC5BpC,MAAM,CAACC,CAAAA,IAAKA,EAAE7B,EAAE,IAAIqE,KAAKH,MAAM,CAAC,CAAC,EAAE;YAErCC,SAASC,OAAO,GAAG;QACpB;QAEA,OAAOrD;IACR;IAEA,MAAMuD,qBAAqB;QAC1B,MAAMC,WAAW,MAAMC,qBAAY,CACjCnE,OAAO,CAAC;YACRT,QAAQJ;YACRsE,QAAQrF,GAAIO,GAAG;YACfyF,WAAW;gBAAEC,SAAS;YAAM;QAC7B;QAED,IAAIH,UAAU;YACb,OAAOrB,IAAAA,2BAAc,EAACqB,SAASA,QAAQ;QACxC;QAEA,OAAO;IACR;IAEA,MAAMI,mBAAmB;QACxB,MAAMC,SAAS,MAAMpG,KAAK6B,OAAO,CAAC;YACjCT,QAAQJ;YACRqF,UAAUpG,GAAIO,GAAG;YACjBI,MAAM;YACN2B,MAAM;YACN,aAAa;gBAAE2D,SAAS;YAAM;YAC9BD,WAAW;gBAAEC,SAAS;YAAM;QAC7B,GAAG;YACF1F,KAAK;QACN;QAEA,OAAO4F,SAAS,CAAC,EAAEA,OAAO5F,GAAG,CAAC,CAAC,GAAG;IACnC;IAEA,MAAM8F,QAAQrG,GAAGW,IAAI,GAAG2F,IAAAA,gBAAS,EAACtG,GAAGW,IAAI,IAAI,EAAE;IAE/C,qCAAqC;IACrC,IAAIX,GAAG4E,MAAM,IAAI,QAAQyB,OAAO;QAC/BrG,GAAG4E,MAAM,GAAG2B,IAAAA,4BAAa,EAACF;IAC3B;IAEA,MAAM/C,SAAqB,MAAMkD,IAAAA,kBAAQ,EAAC;QACzCjF,IAAIkF,IAAAA,sBAAW,EAACzG,GAAGO,GAAG;QACtBF,WAAWqG,IAAAA,0BAAe,EAAC1G,GAAGK,SAAS;QACvC2F,WAAWU,IAAAA,0BAAe,EAAC1G,GAAGgG,SAAS;QACvCW,WAAWD,IAAAA,0BAAe,EAAC1G,GAAG2G,SAAS;QACvCC,WAAWF,IAAAA,0BAAe,EAAC1G,GAAG4G,SAAS;QACvCjG,MAAMX,GAAGW,IAAI;QACb4B,IAAIvC,GAAGuC,EAAE;QACTpB,QAAQsF,IAAAA,sBAAW,EAACzG,GAAGmB,MAAM;QAC7B0F,MAAMC,IAAAA,UAAQ,EAAC9G,GAAG+G,MAAM,IAAa/G,GAAGmB,MAAM,EAAEJ;QAChDP,SAASR,GAAGQ,OAAO,GAAG,CAAC,EAAER,GAAGQ,OAAO,CAAC,CAAC,GAAG;QACxC4F,UAAUpG,GAAGoG,QAAQ,GAAG,CAAC,EAAEpG,GAAGoG,QAAQ,CAAC,CAAC,GAAG;QAC3CY,WAAW,CAAC,CAAChH,GAAGgH,SAAS;QACzB/F,YAAYjB,GAAGiB,UAAU;QACzBuB,MAAMxC,GAAGwC,IAAI,CAAC5B,MAAM,GAAG,IAAIZ,GAAGwC,IAAI,GAAG,EAAE;QACvCyE,WAAW,CAAC,CAACjH,GAAGiH,SAAS;QACzBC,UAAU,CAAC,CAAClH,GAAGkH,QAAQ;QACvB5G,OAAON,GAAGM,KAAK,IAAI;QACnB8B,aAAapC,GAAGoC,WAAW,IAAI;QAC/B+E,YAAYnH,GAAGmH,UAAU,IAAI;QAC7B9E,cAAcrC,GAAGqC,YAAY,IAAI;QACjC+E,WAAWjF;QACXA,gBAAgBA;QAChByC,QAAQT;QACRnC,SAAShC,GAAGgC,OAAO,GAAGhC,GAAGgC,OAAO,CAACgB,GAAG,CAACyD,sBAAW,IAAI,EAAE;QACtDxE,OAAOoF,IAAAA,mBAAY,EAACrH,GAAGgC,OAAO,IAAI,EAAE;QACpCsF,KAAKC,IAAAA,wBAAW,EAACvH,GAAGsH,GAAG,IAAI;QAC3BE,KAAKD,IAAAA,wBAAW,EAACvH,GAAGwH,GAAG,IAAI;QAC3BtF,OAAOuF,IAAAA,4BAAiB,EAACzH,GAAGkC,KAAK;QACjCwF,KAAK1H,GAAGkC,KAAK,GAAGyF,IAAAA,SAAO,EAAC3H,GAAGkC,KAAK,IAAI;QACpCb,gBAAgBrB,EAAAA,qBAAAA,GAAGqB,cAAc,cAAjBrB,yCAAAA,mBAAmBY,MAAM,IAAG,IAAIZ,GAAGqB,cAAc,CAAC2B,GAAG,CAACyD,sBAAW,IAAI,EAAE;QACvFhF,UAAUzB,EAAAA,eAAAA,GAAGyB,QAAQ,cAAXzB,mCAAAA,aAAaY,MAAM,IAAG,IAAIZ,GAAGyB,QAAQ,CAACuB,GAAG,CAACyD,sBAAW,IAAI,EAAE;QACrEmB,mBAAmB5H,EAAAA,2BAAAA,GAAG6H,oBAAoB,cAAvB7H,+CAAAA,yBAAyBY,MAAM,IAAG;OACjD2C,KAAKG,MAAM,GAAG;QACjBlC,OAAO,AAAC+B,KAAKG,MAAM,IAAI1D,GAAGQ,OAAO,GAAIV,KAAKE,GAAGQ,OAAO,EAAEO,MAAM;YAC3D2C,QAAQ;QACT,KAAK;QAELyC,QAAQnG,GAAGoG,QAAQ,GAAGtG,KAAKE,GAAGoG,QAAQ,EAAErF,MAAM;YAC7C2C,QAAQ;QACT,KAAK;QAELoE,YAAY,WAAE9H,GAAG8H,YAAY,2CAAf9H,2BAAAA,MAAiB+H,OAAO,cAAxB/H,+CAAAA;QAEdgI,YAAYhI,GAAG8H,YAAY,GAAGjI,SAASG,GAAG8H,YAAY,CAACC,OAAO,IAAIhH,MAAM;YACvE2C,QAAQ;YACRR,aAAa;QACd,KAAK;QAELZ,MAAMtC,GAAGsC,IAAI,GAAG0C,iBAAiB;OAE7BjE,OAAO;QACVkH,YAAYpC;QACZqC,YAAYhC;IACb,IAAI,CAAC,KACF,CAAC;IAGN,IAAIG,OAAO;QACV,MAAM8B,WAAWC,IAAAA,gCAAe,EAAC/B;QACjC,MAAMgC,qBAAqBF,SAAShF,MAAM,CAACC,CAAAA,IAAK,CAAC;gBAAC;gBAAQ;gBAAW;gBAAW;gBAAO;gBAAQ;gBAAS;gBAAa;aAAa,CAACkF,QAAQ,CAAClF,OAAO,EAAE;QACrJE,OAAOiF,oBAAoB,GAAGF,mBAAmBzH,MAAM,KAAK;IAC7D;IAEA,KAAI0C,eAAAA,OAAOuD,IAAI,cAAXvD,mCAAAA,aAAakF,KAAK,EAAE;YAGnBlF;QAFJ,IAAIA,OAAO3C,IAAI,EAAE2C,OAAO3C,IAAI,GAAG8H,IAAAA,cAAM,EAACnF,OAAO3C,IAAI;QACjD,IAAI2C,OAAOf,EAAE,EAAEe,OAAOf,EAAE,GAAGkG,IAAAA,cAAM,EAACnF,OAAOf,EAAE;QAC3C,KAAIe,eAAAA,OAAOhB,IAAI,cAAXgB,mCAAAA,aAAaiC,OAAO,EAAE;YACzB,KAAK,MAAMmD,KAAKpF,OAAOhB,IAAI,CAACiD,OAAO,CAAE;gBACpC,IAAImD,EAAE/H,IAAI,EAAE+H,EAAE/H,IAAI,GAAG8H,IAAAA,cAAM,EAACC,EAAE/H,IAAI;YACnC;QACD;IACD;IAEA,IAAI,CAAC4C,KAAKI,QAAQ,EAAE;QACnB,MAAM/D,SAAS0D,QAAQvC;IACxB;IAEA,oDAAoD;IACpD,IAAIuC,OAAOuD,IAAI,IAAI,MAAM;QACxB7C,gBAAQ,CAACC,IAAI,CAAC,CAAC,4CAA4C,EAAEX,OAAO/B,EAAE,CAAC,OAAO,EAAE+B,OAAOnC,MAAM,CAAC,CAAC,CAAC;QAChG,OAAO;IACR;IAEA,IAAIoC,KAAKG,MAAM,EAAE;QAChB,IAAIJ,OAAO9C,OAAO,IAAI,QAAQ8C,OAAO9B,KAAK,IAAI,MAAM;YACnD8B,OAAO9C,OAAO,GAAG;QAClB;QAEA,IAAI8C,OAAO8C,QAAQ,IAAI,QAAQ9C,OAAO6C,MAAM,IAAI,MAAM;YACrD7C,OAAO8C,QAAQ,GAAG;QACnB;IACD;IACA,YAAY;IAEZ,OAAO9C;AACR","file":"note.js","sourceRoot":"../../built"}