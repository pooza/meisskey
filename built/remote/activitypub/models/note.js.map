{"version":3,"sources":["remote/activitypub/models/note.js"],"names":["fetchNote","createNote","resolveNote","extractEmojis","fetchReferences","logger","apLogger","toNote","object","uri","expectHost","extractApHost","Error","isPost","getApType","id","attributedTo","getOneApId","dbResolver","DbResolver","getNoteFromApId","value","resolver","silent","Resolver","resolve","entryUri","getApId","note","err","error","message","history","getHistory","debug","JSON","stringify","info","actor","resolvePerson","isSuspended","isDeleted","noteAudience","parseAudience","to","cc","visibility","visibleUsers","length","apMentions","extractApMentions","tag","apHashtags","extractApHashtags","limit","promiseLimit","attachment","toArray","files","map","attach","sensitive","Promise","all","x","resolveImage","filter","image","replyError","reply","inReplyTo","then","warn","catch","e","statusCode","quote","_misskey_quote","quoteUri","quoteUrl","tryResolveNote","match","status","res","StatusError","isClientError","uris","unique","results","find","references","cw","summary","text","_misskey_content","content","htmlToMfm","poll","tryCreateVote","name","index","expiresAt","Date","now","getTime","username","host","vote","deliverQuestionUpdate","_id","choices","findIndex","emojis","apEmojis","emoji","extractPollFromQuestion","undefined","lastFetchedAt","updatePerson","post","createdAt","parseDateWithLimit","published","renote","viaMobile","localOnly","geo","url","getOneApHrefNullable","timeline","isBlockedHost","unlock","getApLock","exist","startsWith","config","tags","host_","toUnicode","toLowerCase","eomjiTags","isEmoji","replace","icon","toSingle","exists","Emoji","findOne","updated","parseDate","updatedAt","findOneAndUpdate","$set","saved","tryStockEmoji","insert","aliases","src","root","page","isCollection","first","t","isCollectionPage","i","items","item","push","next"],"mappings":"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","file":"note.js","sourceRoot":"../../../../built"}