{"version":3,"sources":["server/activitypub.js"],"names":["setResponseType","logger","Logger","router","Router","inbox","ctx","config","disableFederation","throw","signature","httpSignature","parseRequest","req","e","warn","inspect","status","host","toUnicode","URL","keyId","hostname","toLowerCase","isBlockedHost","info","queue","processInbox","request","body","ip","queueId","id","ACTIVITY_JSON","LD_JSON","isActivityPubReq","preferAp","response","vary","accepted","accepts","match","setCacheHeader","note","expiresAt","s","getTime","Date","set","toUTCString","accept","type","post","json","limit","isNoteUserAvailable","user","User","findOne","_id","userId","isDeleted","$ne","isSuspended","noFederation","get","next","ObjectID","isValid","params","Note","deletedAt","$exists","visibility","$in","localOnly","copyOnce","_user","uri","isSelfHost","redirect","meta","fetchMeta","exposeHome","Object","assign","renderActivity","renderNote","packActivity","Outbox","Followers","Following","Featured","isLocalUser","renderKey","userInfo","renderPerson","usernameLower","emoji","Emoji","name","renderEmoji","like","reaction","NoteReaction","noteId","renderLike"],"mappings":"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","file":"activitypub.js","sourceRoot":"../../built"}