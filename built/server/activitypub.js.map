{"version":3,"sources":["server/activitypub.js"],"names":["setResponseType","logger","Logger","router","Router","inbox","ctx","config","disableFederation","throw","signature","httpSignature","parseRequest","req","e","warn","inspect","status","host","toUnicode","URL","keyId","hostname","toLowerCase","isBlockedHost","info","actor","replace","activity","request","body","lazy","includes","toSingle","type","ep","name","exec","meta","limit","duration","max","limiter","undefined","console","log","inboxMassDelOpeMode","queue","processInboxLazy","processInbox","ip","queueId","id","ACTIVITY_JSON","LD_JSON","isActivityPubReq","preferAp","response","vary","accepted","accepts","match","setCacheHeader","note","expiresAt","s","getTime","Date","set","toUTCString","accept","post","json","isNoteUserAvailable","user","User","findOne","_id","userId","isDeleted","$ne","isSuspended","noFederation","get","next","ObjectID","isValid","params","Note","deletedAt","$exists","visibility","$in","localOnly","copyOnce","_user","uri","isSelfHost","redirect","fetchMeta","exposeHome","Object","assign","renderActivity","renderNote","packActivity","Outbox","Followers","Following","Featured","isLocalUser","renderKey","userInfo","renderPerson","usernameLower","emoji","Emoji","renderEmoji","like","reaction","NoteReaction","noteId","renderLike"],"mappings":"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","file":"activitypub.js","sourceRoot":"../../built"}