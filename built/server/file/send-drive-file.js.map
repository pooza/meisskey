{"version":3,"sources":["server/file/send-drive-file.js"],"names":["commonReadableHandlerGenerator","ctx","e","serverLogger","error","status","set","file","mongodb","ObjectID","isValid","params","id","sendError","fileId","DriveFile","findOne","_id","metadata","withoutChunks","isRemote","_user","host","url","uri","path","cleanup","Promise","res","rej","tmp","fd","downloadUrl","mime","ext","detectTypeWithCheck","convertFile","query","includes","convertToJpeg","convertToPngOrJpeg","startsWith","generateVideoThumbnail","data","fs","promises","readFile","type","sendNormal","StatusError","isClientError","statusCode","deletedAt","fileSystem","isThumbnail","isWebpublic","key","storageProps","thumbnailKey","webpublicKey","InternalStorage","resolvePath","filename","rename","suffix","extname","undefined","toString","read","accessKey","readable","on","contentType","thumb","DriveFileThumbnail","bucket","getDriveFileThumbnailBucket","openDownloadStream","sendRaw","web","DriveFileWebpublic","getDriveFileWebpublicBucket","getDriveFileBucket","body","FILE_TYPE_BROWSERSAFE","contentDisposition"],"mappings":"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","file":"send-drive-file.js","sourceRoot":"../../../built"}